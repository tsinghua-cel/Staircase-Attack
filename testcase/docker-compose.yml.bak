
version: "3.9"

services:
  mysql:
    container_name: "ethmysql"
    image: "mysql:latest"
    environment:
      - MYSQL_ROOT_PASSWORD=12345678
    ports:
      - "3306:3306"
    restart: always
    privileged: true
    volumes:
      - "/etc/localtime:/etc/localtime"
      - "./data/mysql/data:/var/lib/mysql"
      - "./config/mysql/conf/my.cnf:/etc/my.cnf"
      - "./config/mysql/init:/docker-entrypoint-initdb.d/"
    networks:
      - meta

  execute-1:
    image: geth:v1.13-base
    container_name: execute-1
    entrypoint: /usr/local/bin/execution.sh
    deploy:
      restart_policy:
        condition: on-failure
        delay: 1s
        max_attempts: 100
        window: 120s
    ports:
      - "10000:8551"
      - "11000:8545"
    volumes:
      - ./config:/root/config
      - ./data/execute-1:/root/gethdata
    networks:
      - meta

  execute-2:
    image: geth:v1.13-base
    container_name: execute-2
    entrypoint: /usr/local/bin/execution.sh
    deploy:
      restart_policy:
        condition: on-failure
        delay: 1s
        max_attempts: 100
        window: 120s
    ports:
      - "10001:8551"
      - "11001:8545"
    volumes:
      - ./config:/root/config
      - ./data/execute-2:/root/gethdata
    networks:
      - meta

  attacker:
    image: attacker:latest
    container_name: attacker
    entrypoint: /usr/local/bin/attacker.sh
    environment:
      - NAME=attacker

    deploy:
      restart_policy:
        condition: on-failure
        delay: 1s
        max_attempts: 100
        window: 120s
    ports:
      - "12000:10000"
      - "12100:10001"
    volumes:
      - ./config/attacker-config.toml:/root/config.toml
      - ./strategy/strategy-3.json:/root/strategy.json
      - ./data/attacker:/root/attackerdata
    depends_on:
      - mysql
    networks:
      meta:
        ipv4_address: 172.99.1.150

  beacon-1:
    image: beacon:modified
    container_name: beacon-1
    entrypoint: /usr/local/bin/beacon-node.sh
    environment:
      - ALLPEERS= --peer /ip4/172.99.1.3/tcp/13000/p2p/16Uiu2HAmK1PQ8CnEZCMN23M3P5ywjP8GxekXMSTGo7N7RV2eGW4v 
      - EXECUTE=execute-1
      - MAXPEERS=70
      - P2PKEY=96ea30459d263874d9b2484070680961c0e6f70f20237a97a231bb5f628d61c4
      - ATTACKER_SERVICE_URL=http://172.17.0.1:12000 

    deploy:
      restart_policy:
        condition: on-failure
        delay: 1s
        max_attempts: 100
        window: 120s
    ports:
      - "13000:4000"
      - "14000:3500"
    volumes:
      - ./config:/root/config
      - ./data/beacon-1:/root/beacondata
    depends_on:
      - execute-1
    networks:
      meta:
        ipv4_address: 172.99.1.2

  beacon-2:
    image: beacon:base
    container_name: beacon-2
    entrypoint: /usr/local/bin/beacon-node.sh
    environment:
      - ALLPEERS= --peer /ip4/172.99.1.2/tcp/13000/p2p/16Uiu2HAmAhPZoURgoM8DcViSwKKGq8N5xgDdqXDYUHc1Nyp3AH73 
      - EXECUTE=execute-2
      - MAXPEERS=70
      - P2PKEY=96c13dfe384bbc594d7235cf9b9a7b735d4f8bcec372374f5957e38dc1cf0a78
      - ATTACKER_SERVICE_URL=http://172.17.0.1:12000 

    deploy:
      restart_policy:
        condition: on-failure
        delay: 1s
        max_attempts: 100
        window: 120s
    ports:
      - "13001:4000"
      - "14001:3500"
    volumes:
      - ./config:/root/config
      - ./data/beacon-2:/root/beacondata
    depends_on:
      - execute-2
    networks:
      meta:
        ipv4_address: 172.99.1.3

  validator-1:
    image: validator:modified
    container_name: validator-1
    entrypoint: /usr/local/bin/validator.sh
    environment:
      - VALIDATORS_NUM=500
      - VALIDATORS_INDEX=0
      - BEACONRPC=beacon-1:4000
      - ATTACKER_SERVICE_URL=http://172.17.0.1:12000

    deploy:
      restart_policy:
        condition: on-failure
        delay: 1s
        max_attempts: 100
        window: 120s
    volumes:
      - ./config:/root/config
      - ./data/validator-1:/root/validatordata
    depends_on:
      - beacon-1
    networks:
      - meta

  validator-2:
    image: validator:base
    container_name: validator-2
    entrypoint: /usr/local/bin/validator.sh
    environment:
      - VALIDATORS_NUM=500
      - VALIDATORS_INDEX=500
      - BEACONRPC=beacon-2:4000
      - ATTACKER_SERVICE_URL=http://172.17.0.1:12000

    deploy:
      restart_policy:
        condition: on-failure
        delay: 1s
        max_attempts: 100
        window: 120s
    volumes:
      - ./config:/root/config
      - ./data/validator-2:/root/validatordata
    depends_on:
      - beacon-2
    networks:
      - meta


networks:
  meta:
    driver: bridge
    ipam:
      config:
        - subnet: 172.99.0.0/16
